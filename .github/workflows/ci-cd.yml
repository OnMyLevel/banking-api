  name: CI/CD Pipeline

  on:
    push:
      branches: [main]
    pull_request:
      branches: [main]

  env:
    AWS_REGION: us-east-1
    ECR_REPOSITORY: banking-api-poc
    ECS_CLUSTER: banking-api-poc-cluster
    ECS_SERVICE: banking-api-poc-service
    CONTAINER_NAME: banking-api

  jobs:
    build-and-test:
      name: Build and Test
      runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'temurin'
            cache: 'maven'

        - name: Build application
          run: mvn clean package -DskipTests

        - name: Upload artifact
          uses: actions/upload-artifact@v4
          with:
            name: banking-api-jar
            path: target/*.jar

    build-and-push-docker:
      name: Build and Push to ECR
      runs-on: ubuntu-latest
      needs: build-and-test
      if: github.ref == 'refs/heads/main'

      outputs:
        image: ${{ steps.build-image.outputs.image }}

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ env.AWS_REGION }}

        - name: Login to Amazon ECR
          id: login-ecr
          uses: aws-actions/amazon-ecr-login@v2

        - name: Build, tag, and push image to Amazon ECR
          id: build-image
          env:
            ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
            IMAGE_TAG: ${{ github.sha }}
          run: |
            docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
            docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
            echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    deploy-to-ecs:
      name: Deploy to ECS Fargate
      runs-on: ubuntu-latest
      needs: build-and-push-docker
      if: github.ref == 'refs/heads/main'

      steps:
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ env.AWS_REGION }}

        - name: Deploy to ECS
          run: |
            aws ecs update-service \
              --cluster ${{ env.ECS_CLUSTER }} \
              --service ${{ env.ECS_SERVICE }} \
              --force-new-deployment \
              --region ${{ env.AWS_REGION }}
            
            echo "✅ Deployment initiated successfully"

        - name: Wait for service stability
          run: |
            echo "⏳ Waiting for service to stabilize..."
            aws ecs wait services-stable \
              --cluster ${{ env.ECS_CLUSTER }} \
              --services ${{ env.ECS_SERVICE }} \
              --region ${{ env.AWS_REGION }}
            
            echo "✅ Service is stable and running"

        - name: Get service info
          run: |
            aws ecs describe-services \
              --cluster ${{ env.ECS_CLUSTER }} \
              --services ${{ env.ECS_SERVICE }} \
              --region ${{ env.AWS_REGION }} \
              --query 'services[0].{Status:status,Running:runningCount,Desired:desiredCount}' \
              --output table
