  name: CI/CD Pipeline
  on:
    push:
      branches: [main]
    pull_request:
      branches: [main]

  env:
    AWS_REGION: us-east-1
    ECR_REPOSITORY: banking-api-poc  # üëà CORRIG√â !

  jobs:
    build-and-test:
      name: Build and Test
      runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'temurin'
            cache: 'maven'

        - name: Build application
          run: mvn clean package -DskipTests

        - name: Upload artifact
          uses: actions/upload-artifact@v4
          with:
            name: banking-api-jar
            path: target/*.jar

    build-and-push-docker:
      name: Build and Push to ECR
      runs-on: ubuntu-latest
      needs: build-and-test
      if: github.ref == 'refs/heads/main'

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ env.AWS_REGION }}

        - name: Login to Amazon ECR
          id: login-ecr
          uses: aws-actions/amazon-ecr-login@v2

        - name: Build and push Docker image
          env:
            ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
            IMAGE_TAG: ${{ github.sha }}
          run: |
            echo "üèóÔ∏è Building Docker image..."
            docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
            docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
            
            echo "üì§ Pushing to ECR: $ECR_REGISTRY/$ECR_REPOSITORY"
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
            
            echo "‚úÖ Image pushed successfully!"
            echo "Image URI: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

    deploy:
      name: Deploy to AWS
      runs-on: ubuntu-latest
      needs: build-and-push-docker
      if: github.ref == 'refs/heads/main'

      steps:
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ env.AWS_REGION }}

        - name: Deploy info
          run: |
            echo "‚úÖ Docker image ready in ECR"
            echo "Repository: 855869819118.dkr.ecr.us-east-1.amazonaws.com/banking-api-poc"
            echo "Next: Configure deployment strategy (App Runner, ECS, or EC2)"